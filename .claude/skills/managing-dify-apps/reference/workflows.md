# 詳細ワークフロー

## 目次
- 新規アプリの作成
- 既存アプリの編集
- 検証とテスト
- 反復改善ループ
- トラブルシューティングパターン

---

## 新規Difyアプリを作成

新しいアプリケーションをゼロから作成したい場合のワークフローです。

### ステップバイステップワークフロー

**進捗を確認しながら実行：**

```
新規アプリ作成：
- [ ] ステップ1：アプリの要件を整理
- [ ] ステップ2：アプリの種類を選択
- [ ] ステップ3：適切なテンプレートを選択
- [ ] ステップ4：初期YAMLを生成
- [ ] ステップ5：設定を検証
- [ ] ステップ6：Difyに登録
- [ ] ステップ7：テスト実行
- [ ] ステップ8：結果を確認
- [ ] ステップ9：反復改善または完成
```

### ステップ1：アプリの要件を整理

作りたいものについて詳しく説明してください：

**良い例：**
- 「顧客からのよくある質問に自動で答えるチャットボット。ナレッジベースから情報を取得して、親切なトーンで回答する」
- 「テキストから顧客の感情を分析し、感情（ポジティブ・ニュートラル・ネガティブ）に応じて異なる対応をするワークフロー」
- 「天気データを取得するAPI連携アプリ。データを取得して要約してユーザーに表示」

**含めるべき重要な情報：**
- 主な目的は？
- ユーザーは何を入力する？
- 出力はどんな形式？
- 特別な要件はあるか？（トーン、フォーマット、連携など）

### ステップ2：アプリの種類を選択

要件に基づいて選択してください。詳細は [templates.md](templates.md) を参照。

| 種類 | 推奨用途 | 複雑度 |
|------|--------|-------|
| **Q&Aチャットボット** | シンプルな質問応答、カスタマーサポート | ⭐ 低 |
| **ワークフロー** | 複数ステップ処理、データ変換 | ⭐⭐ 中 |
| **条件分岐ロジック** | 判定木、動的ルーティング | ⭐⭐⭐ 高 |
| **API連携** | 外部サービス呼び出し、データ取得 | ⭐⭐⭐ 高 |

### ステップ3：適切なテンプレートを選択

Claudeが5つのテンプレートから選択するのをサポート：
- `1_simple_chatbot.dsl.yml` → Q&A
- `2_echo_workflow.dsl.yml` → シンプルワークフロー
- `3_llm_workflow.dsl.yml` → 標準ワークフロー
- `4_conditional_workflow.dsl.yml` → 複雑なロジック
- `5_http_api_workflow.dsl.yml` → API連携

詳細は [templates.md](templates.md) を参照。

### ステップ4：初期YAMLを生成

Claudeが要件に基づいて `app.dsl.yml` をカスタマイズして生成：
- アプリ名と説明を設定
- 入出力スキーマを設定
- プロンプトと指示を作成
- ワークフローステップを定義（必要な場合）

### ステップ5：設定を検証

エラーを早期に発見するため検証を実行：

```bash
docker compose run --rm dify-creator validate --dsl app.dsl.yml
```

**成功時の出力例：**
```
✅ 検証成功：DSLは構造的に有効です
```

**エラーの場合：**
- 報告されたエラーを修正
- 成功するまで再検証

詳細は [troubleshooting.md](troubleshooting.md) を参照。

### ステップ6：Difyに登録

検証済みの設定をアップロードしてアプリを作成：

```bash
docker compose run --rm dify-creator import --dsl app.dsl.yml
```

`app_id` が返されます。これは後の編集で使用するので **保存してください**。

### ステップ7：テスト実行

サンプル入力でアプリを実行して動作確認：

```bash
docker compose run --rm dify-creator sync \
  --dsl app.dsl.yml \
  --app-id <返されたapp_id> \
  --inputs-json examples/inputs.json
```

結果は `artifacts/run_result.json` に保存されます。

### ステップ8：結果を確認

テスト結果を確認：
- 期待通りのフォーマットが出力されたか？
- 回答は使用例に適切か？
- エラーや予期しない動作はないか？

### ステップ9：反復改善または完成

**結果が良い場合：** ✅ アプリの準備完了。Difyウェブサイトで公開可能

**結果に改善が必要な場合：** → 下記「編集」ワークフローを使用

---

## 既存Difyアプリを編集

実行中のアプリを修正する場合のワークフローです。

### ステップバイステップワークフロー

**進捗を確認しながら実行：**

```
既存アプリ編集：
- [ ] ステップ1：Difyからアプリのapp_idを取得
- [ ] ステップ2：希望する変更を説明
- [ ] ステップ3：現在の設定をダウンロード
- [ ] ステップ4：修正を適用
- [ ] ステップ5：変更をプレビュー（確認用）
- [ ] ステップ6：設定を検証
- [ ] ステップ7：Difyにアップロード
- [ ] ステップ8：テストを実行
- [ ] ステップ9：確認して反復改善
```

### ステップ1：app_idを取得

Difyのウェブサイトからアプリのapp_idを確認：

```
https://cloud.dify.ai/app/abc123def456/overview
                         ^^^^^^^^^^^^^^
                          これがapp_id
```

### ステップ2：変更を説明

修正内容を明確に説明してください。例：

**良い説明：**
- 「プロンプトをもっと専門的でフォーマルにして」
- 「応答内容をリスト形式から箇条書きに変更」
- 「入力フィールド名を 'question' から 'customer_query' に変更」
- 「ユーザータイプによる異なる処理を追加」

**曖昧な説明（避ける）：**
- 「改善して」
- 「修正して」
- 「プロンプトを変更」

### ステップ3：現在の設定をダウンロード

Claudeが現在実行中の設定をダウンロード：

```bash
docker compose run --rm dify-creator export \
  --app-id <あなたのapp_id> \
  --out app.dsl.yml
```

ローカルコピーが作成されます。

### ステップ4：修正を適用

Claudeが説明に基づいて設定を修正：
- プロンプトと指示を編集
- ワークフローステップを追加・削除
- 変数とスキーマを変更
- 条件分岐ロジックを更新
- APIエンドポイントを修正（必要な場合）

### ステップ5：変更をプレビュー（確認用）

**Claudeが要約を表示：**
- 具体的に何が変わるのか？
- 追加・削除されたコード行？
- 変数の修正内容？

**確認して承認してください。**

### ステップ6：設定を検証

修正済みYAMLが正しい構文か確認：

```bash
docker compose run --rm dify-creator validate --dsl app.dsl.yml
```

検証失敗時は、Claudeが自動で問題を修正して再検証。

### ステップ7：Difyにアップロード

修正内容をライブアプリに適用：

```bash
docker compose run --rm dify-creator import \
  --dsl app.dsl.yml \
  --app-id <あなたのapp_id>
```

変更は「ドラフト」状態で適用（公開前）。

### ステップ8：テストを実行

修正したアプリをサンプル入力でテスト：

```bash
docker compose run --rm dify-creator sync \
  --dsl app.dsl.yml \
  --app-id <あなたのapp_id> \
  --inputs-json examples/inputs.json
```

### ステップ9：確認して反復改善

**結果が良い場合：** ✅
- 修正完了
- Difyウェブサイトで公開準備完了

**調整が必要な場合：** 🔄
- 何が違うか・何が足りないかを説明
- Claudeが自動で反復実行：修正 → 検証 → テスト
- 満足するまで繰り返し

検証フィードバックループで各反復がエラーなし・テスト済みになります。

---

## 検証ワークフロー

いつでも設定を検証できます。

```
検証チェックリスト：
- [ ] YAML構文が正しい
- [ ] 必須フィールドが含まれている
- [ ] アプリのモード（workflow/chat/agent）が有効
- [ ] ノード定義が正しく構造化されている
- [ ] 変数名が一貫している
- [ ] プロンプトが明確で実行可能
```

**検証を実行：**

```bash
docker compose run --rm dify-creator validate --dsl app.dsl.yml
```

**エラーが発生した場合：**
1. エラーメッセージを注意深く読む（具体的な問題を指摘）
2. `app.dsl.yml` のエラー部分を修正
3. すぐに再検証
4. 検証がパスするまで進めない

---

## テスト実行ワークフロー

```
テストワークフロー：
- [ ] ステップ1：テスト入力を準備
- [ ] ステップ2：テスト実行を実行
- [ ] ステップ3：artifacts/run_result.json を確認
- [ ] ステップ4：結果と期待値を比較
- [ ] ステップ5：反復改善または完成
```

**テストを実行：**

```bash
docker compose run --rm dify-creator sync \
  --dsl app.dsl.yml \
  --app-id <app_id> \
  --inputs-json examples/inputs.json \
  --out-dir artifacts
```

**結果を確認：**
- `artifacts/run_result.json` にアプリの出力が含まれる
- 期待値と比較
- 形式や内容が一致しない場合は編集ワークフローで反復改善

---

## 反復改善パターン

### パターン1：クイック反復（修正 → テスト → 確認）

```
1. 小さく焦点を絞った変更を実施（例：プロンプトのトーン調整）
2. すぐに検証とテストを実行
3. 結果をすばやく確認
4. 満足するまで反復
```

**推奨用途：** プロンプト調整、変数変更、小さな修正

### パターン2：構造化反復（収集 → 計画 → 実装 → テスト）

```
1. 必要な変更をすべて集める
2. アプローチを計画（どのテンプレート？どのステップ？）
3. バッチで実装
4. マイルストーンごとに十分にテスト
```

**推奨用途：** 大規模なリストラクチャリング、複雑なワークフロー、アーキテクチャ変更

### パターン3：検証駆動開発（変更 → すぐに検証 → 修正 → テスト）

```
1. 変更を実施
2. すぐに検証（待たない）
3. エラーがあれば修正
4. 検証がパスしたらテスト実行
```

**ベストプラクティス：** 早期にエラーを発見でき、デバッグ時間を削減

---

## よくある反復改善シナリオ

### シナリオ：「出力フォーマットが間違っている」

**対応方法：**
1. 問題を説明：「応答は段落形式ではなく箇条書き形式にして」
2. Claudeがプロンプトを修正して形式を強制
3. 同じ入力でテスト
4. 出力形式が期待と一致することを確認

### シナリオ：「アプリが遅い」

**対応方法：**
1. ワークフローに不要なステップがないか確認
2. 可能なら処理を簡潔に
3. APIコールが必要か検討
4. 一般的な入力で性能をテスト

### シナリオ：「一部の入力でエラーが出る」

**対応方法：**
1. 問題の入力でテスト
2. ワークフローにエラーハンドリングを追加（必要な場合）
3. 入力検証ルールを改善
4. エッジケースでテスト

### シナリオ：「新機能を追加したい」

**対応方法：**
1. 現在のアプリから始める（編集ワークフロー使用）
2. 新機能をワークフローステップとして追加
3. 新しい構造を検証
4. 統合された機能をテスト
5. 期待通り動作するまで反復改善

---

## ベストプラクティス

✅ **やるべきこと：**
- 意味のある変更ごとにテストを実行
- エラーメッセージを注意深く読む（通常は明確）
- チェックリストを使って進捗を追跡
- 不確実なら説明を求める
- 複雑な変更は小さな反復に分割

❌ **避けるべきこと：**
- 確信がなくても検証をスキップ
- 複数の無関連な変更を同時にしない（デバッグが難しくなる）
- テストなしでDifyにアップロード
- エラーメッセージを無視（根本原因を修正）
- すべてを1回の反復で修正しようとする
- テストなしでエッジケースが機能すると仮定
